0. Clean database.
delete from callerComp;
delete from edge;
delete from flow;
delete from iccg;
delete from intentFilter;
delete from node;
delete from permission;



1. DroidDreamLight:

select node_id,  full_name, tgtId from ( (select node_id, e.tgt_node_id as tgtId from intentFilter ift,  edge e where ift.iccg_id=8 and (ift.name like '%PHONE_STATE%') and e.src_node_id=ift. node_id)  as tmp,

(SELECT  distinct f1.src_node_id as serviceId  FROM flow f1, flow f2, flow f3 where f1.iccg_id=8 and f2.iccg_id=8 and f3.iccg_id=8 and f1.src_node_id=f2.src_node_id and f2.src_node_id=f3.src_node_id and f1.source='$getDeviceId' and f1.sink='!INTERNET' and  f2.source='$InstalledPackages' and f2.sink='!INTERNET' and  f3.source='$getSubscriberId' and f3.sink='!INTERNET' ) as tmp2,

 node as nd) where node_id=nd.id and nd.type='receiver' and serviceId=tgtId

 2.1 Kungfu1:
select * from
(
select distinct serviceId from
(
  select node_id as recv_id, tgtId as serviceId, tgt_node_id as activity_id from (
    /*receiver a will launch b*/
      select node_id,  full_name, tgtId from ( (select node_id, e.tgt_node_id as tgtId from intentFilter ift,  edge e where ift.iccg_id=66 and (ift.name like '%BOOT_COMPLETE%') and e.src_node_id=ift. node_id)  as tmp,

        /*service  b that generates src-sink*/
          (SELECT  distinct f1.src_node_id as serviceId  FROM flow f1, flow f2, flow f3, flow f4 where f1.iccg_id=66 and f2.iccg_id=66 and f3.iccg_id=66 and f4.iccg_id=66 and f1.src_node_id=f2.src_node_id and f2.src_node_id=f3.src_node_id and f3.src_node_id=
          f4.src_node_id and f1.source='$getDeviceId' and f1.sink='!INTERNET' and  f2.source='$getLine1Number' and f2.sink='!INTERNET' and  f3.source='$MODEL' and f3.sink='!INTERNET' and f4.source='$BRAND' and f4.sink='!INTERNET' ) as tmp2,

            /*service b launches activity c. */
               node as nd) where node_id=nd.id and nd.type='receiver' and serviceId=tgtId) as tmp3, edge as eg, node as activity where eg. src_node_id=tgtId and eg.tgt_node_id=activity.id and activity.type='activity'
                 /*install apk can be in other component. */
                 ) as tmp3, edge as eInstall, node as nInstall where eInstall.iccg_id=65 and eInstall.tgt_node_id=nInstall.id and nInstall.full_name='INSTALL_APK'
                 /*no encrypt c&c server for kungfu1.*/
                 ) as tmp4 inner join flow as f5 on (tmp4.serviceId=f5.src_node_id and NOT(f5.sink_node_id=f5.src_node_id and f5.source='$ENC/DEC' and f5.sink='!INTERNET')) 

 2.2 Kungfu2:
 select distinct serviceId from
 (
 select distinct serviceId from
 (
   select node_id as recv_id, tgtId as serviceId, tgt_node_id as activity_id from (
     /*receiver a will launch b*/
       select node_id,  full_name, tgtId from ( (select node_id, e.tgt_node_id as tgtId from intentFilter ift,  edge e where ift.iccg_id=71 and (ift.name like '%BOOT_COMPLETE%') and e.src_node_id=ift. node_id)  as tmp,

         /*service  b that generates src-sink*/
           (SELECT  distinct f1.src_node_id as serviceId  FROM flow f1, flow f2, flow f3, flow f4 where f1.iccg_id=71 and f2.iccg_id=71 and f3.iccg_id=71 and f1.src_node_id=f2.src_node_id and f2.src_node_id=f3.src_node_id and f1.source='$getDeviceId' and f1.sink='!FILE' and  f2.source='$BRAND' and f2.sink='!FILE' and  f3.source='$MODEL' and f3.sink='!FILE') as tmp2,

             /*service b launches activity c. */
                node as nd) where node_id=nd.id and nd.type='receiver' and serviceId=tgtId) as tmp3, edge as eg, node as activity where eg. src_node_id=tgtId and eg.tgt_node_id=activity.id and activity.type='activity'
                  /*install apk can be in other component. */
                  ) as tmp3, edge as eInstall, node as nInstall where eInstall.iccg_id=71 and eInstall.tgt_node_id=nInstall.id and nInstall.full_name<>'INSTALL_APK'
                 /*encrypt c&c server and send it to internet*/
                  ) as tmp4 inner join flow as f5 on (tmp4.serviceId=f5.src_node_id and f5.sink_node_id=f5.src_node_id and not(f5.source='$ENC/DEC' and f5.sink='!INTERNET')) 

 2.3 Kungfu3:
select * from
(
select distinct serviceId from
(
  select node_id as recv_id, tgtId as serviceId, tgt_node_id as activity_id from (
    /*receiver a will launch b*/
      select node_id,  full_name, tgtId from ( (select node_id, e.tgt_node_id as tgtId from intentFilter ift,  edge e where ift.iccg_id=65 and (ift.name like '%BOOT_COMPLETE%') and e.src_node_id=ift. node_id)  as tmp,

        /*service  b that generates src-sink*/
          (SELECT  distinct f1.src_node_id as serviceId  FROM flow f1, flow f2, flow f3, flow f4 where f1.iccg_id=65 and f2.iccg_id=65 and f3.iccg_id=65 and f4.iccg_id=65 and f1.src_node_id=f2.src_node_id and f2.src_node_id=f3.src_node_id and f3.src_node_id=
          f4.src_node_id and f1.source='$getDeviceId' and f1.sink='!INTERNET' and  f2.source='$getLine1Number' and f2.sink='!INTERNET' and  f3.source='$MODEL' and f3.sink='!INTERNET' and f4.source='$BRAND' and f4.sink='!INTERNET' ) as tmp2,

            /*service b launches activity c. */
               node as nd) where node_id=nd.id and nd.type='receiver' and serviceId=tgtId) as tmp3, edge as eg, node as activity where eg. src_node_id=tgtId and eg.tgt_node_id=activity.id and activity.type='activity'
                 /*install apk can be in other component. */
                 ) as tmp3, edge as eInstall, node as nInstall where eInstall.iccg_id=65 and eInstall.tgt_node_id=nInstall.id and nInstall.full_name='INSTALL_APK'
                 /*encrypt c&c server and send it to internet*/
                 ) as tmp4 inner join flow as f5 on (tmp4.serviceId=f5.src_node_id and f5.sink_node_id=f5.src_node_id and f5.source='$ENC/DEC' and f5.sink='!INTERNET') 

 2.4 Kungfu4:
 select * from
 (
 select distinct serviceId from
 (
   select node_id as recv_id, tgtId as serviceId, tgt_node_id as activity_id from (
     /*receiver a will launch b*/
       select node_id,  full_name, tgtId from ( (select node_id, e.tgt_node_id as tgtId from intentFilter ift,  edge e where ift.iccg_id=73 and (ift.name like '%BOOT_COMPLETE%') and e.src_node_id=ift. node_id)  as tmp,

         /*service  b that generates src-sink*/
           (SELECT  distinct f1.src_node_id as serviceId  FROM flow f1, flow f2, flow f3  where f1.iccg_id=73 and f2.iccg_id=73 and f3.iccg_id=73 and f1.src_node_id=f2.src_node_id and f2.src_node_id=f3.src_node_id and f1.source='$getDeviceId' and f1.sink='!FILE' and  f2.source='$BRAND' and f2.sink='!FILE' and  f3.source='$MODEL' and f3.sink='!FILE') as tmp2,

             /*service b launches activity c. */
                node as nd) where node_id=nd.id and nd.type='receiver' and serviceId=tgtId) as tmp3, edge as eg, node as activity where eg. src_node_id=tgtId and eg.tgt_node_id=activity.id and activity.type='activity'
                  /*install apk can be in other component. */
                  ) as tmp3, edge as eInstall, node as nInstall where eInstall.iccg_id=73 and eInstall.tgt_node_id=nInstall.id and nInstall.full_name='INSTALL_APK'
                  /*encrypt c&c server and parse it by native call..*/
                  ) as tmp4 inner join flow as f5 on (tmp4.serviceId=f5.src_node_id and f5.sink_node_id=f5.src_node_id and f5.source='$ENC/DEC' and f5.sink='!EXEC') 



receiver->service(leak data)->activity


3. Geinimi

receiver->service(self loop and leak data)


  select  node_id as recv_id, tgtId as serviceId, tgt_node_id as activity_id from (
    /*receiver a will launch b*/
      select node_id,  full_name, tgtId from ( (select node_id, e.tgt_node_id as tgtId from intentFilter ift,  edge e where ift.iccg_id=56 and (ift.name like '%BOOT_COMPLETE%') and e.src_node_id=ift. node_id)  as tmp,

        /*service  b that generates src-sink*/
          (SELECT  distinct f1.src_node_id as serviceId  FROM flow f1, flow f2, flow f3, flow f4 where f1.iccg_id=56 and f2.iccg_id=56 and f3.iccg_id=56 and f4.iccg_id=56 and f1.src_node_id=f2.src_node_id and f2.src_node_id=f3.src_node_id and f3.src_node_id=f4.src_node_id and f1.source='$getDeviceId' and f1.sink='!INTERNET' and  f2.source='$getLine1Number' and f2.sink='!INTERNET' and  f3.source='$MODEL' and f3.sink='!INTERNET' and f4.source='$BRAND' and f4.sink='!INTERNET' ) as tmp2,

            /*service b launches  itself. */
               node as nd) where node_id=nd.id and nd.type='receiver' and serviceId=tgtId) as tmp3, edge as eg, node as self where eg. src_node_id=tgtId and eg.tgt_node_id=tgtId and self.type='service' and self.id=tgtId


4. GoldDream

receiver->service

/*Receiver launches service.*/
select node_id,  full_name, tgtId from ( (select node_id, e.tgt_node_id as tgtId from intentFilter ift,  edge e where ift.iccg_id=58 and ( ift.name like '%PHONE_STATE%' and ift.name like '%BOOT_COMPLETED%' and ift.name like '%SMS_RECEIVED%' and ift.name like '%NEW_OUTGOING_CALL%') and e.src_node_id=ift. node_id)  as tmp, 
(   /*Service leaks data*/
SELECT  distinct f1.src_node_id as serviceId  FROM flow f1, flow f2, flow f3 where f1.iccg_id=58 and f2.iccg_id=58 and f3.iccg_id=58 and f1.src_node_id=f2.src_node_id and f2.src_node_id=f3.src_node_id and f1.source='$getDeviceId' and f1.sink='!INTERNET' and  f2.source='$getSimSerialNumber' and f2.sink='!INTERNET' and  f3.source='$getSubscriberId' and f3.sink='!INTERNET' 
) as tmp2,

 node as nd) where node_id=nd.id and nd.type='receiver' and serviceId=tgtId


 5. ADRD (we can strengthen the query if there are too much false positives.,e.g, ENC/DEC)

receiver -> receiver <-> service

select servId from
(
select servId from 
(
select e2.tgt_node_id as servId from 
/*recv1->recv2*/
(
select tmp.src_node_id as recv1Id, tmp.tgt_node_id as recv2Id from (select * from edge e1, node recv1, node recv2 where e1.iccg_id=75 and recv1.iccg_id=75 and recv2.iccg_id=75  and recv1.type='receiver' and recv2.type='receiver' and e1.src_node_id=recv1.id and e1.tgt_node_id=
recv2.id) as tmp left join intentFilter as ift where ift.node_id = tmp.src_node_id and (ift.name like '%BOOT_COMPLETED%')
) as tmp2, edge as e2, edge as e3 where  e2.iccg_id=75 and e3.iccg_id=75 and e2.src_node_id=tmp2.recv2Id and e3.tgt_node_id=tmp2.recv2Id and e3.src_node_id=e2.tgt_node_id 
) as tmp3 left join node as servNode where (servNode.id=tmp3.servId and servNode.type='service') 
) as tmp4 inner join flow as f1 on f1.src_node_id=tmp4.servId
inner join flow as f2 on f2.src_node_id=tmp4.servId
inner join flow as f3 on f3.src_node_id=tmp4.servId
where  f1.source='$getDeviceId' and f1.sink='!ENC/DEC' and  f2.source='$getSubscriberId' and f2.sink='!ENC/DEC' and  f3.source='$ENC/DEC' and f3.sink='!INTERNET' and f1.src_node_id=f1.sink_node_id and f2.src_node_id=f2.sink_node_id and f3.src_node_id=f3.sink_node_id


6. anserverBot (ONly one receiver, maybe several FPs.)


select tmp2.recvId from
(
select tmp.id as recvId, cc.callee as ce from 
(
select * from node as recv,  intentFilter as ift where recv.iccg_id=60 and recv.id=ift.node_id and ift.priority>1000 and (ift.name like '%BOOT_COMPLETED%') and (ift.name like '%SMS_RECEIVED%') and (ift.name like '%UMS_CONNECTED%') and (ift.name like '%PICK_WIFI_WORK%') and recv.type='receiver'
) as tmp left join callerComp as cc on cc.node_id=tmp.id
) as tmp2, flow as f1, flow as f2, flow as f3, flow as f4 where tmp2.ce='void abortBroadcast()' and tmp2.recvId=f1.src_node_id and tmp2.recvId=f2.src_node_id and tmp2.recvId=f3.src_node_id and tmp2.recvId=f4.src_node_id
and f1.source='$getDeviceId' and f1.sink='!INTERNET' and  f2.source='$MANUFACTURER' and f2.sink='!INTERNET' and  f3.source='$getSubscriberId' and f3.sink='!INTERNET' and  f4.source='$MODEL' and f4.sink='!INTERNET'



7. BaseBridge.


select distinct tmp3.servId from
(
select e1.tgt_node_id as servId from
(
select tmp.id as recvId, cc.callee as ce from 
(
select * from node as recv,  intentFilter as ift where recv.iccg_id=61 and recv.id=ift.node_id and ift.priority>1000 and (ift.name like '%BOOT_COMPLETED%') and (ift.name like '%SMS_RECEIVED%') and (ift.name like '%CONNECTIVITY_CHANGE%') and (ift.name like '%BATTERY_LOW%') and recv.type='receiver'
) as tmp left join callerComp as cc on cc.node_id=tmp.id
) as tmp2, edge as e1, node as serv where tmp2.ce='void abortBroadcast()' and e1.src_node_id=tmp2.recvId and serv.id=e1.tgt_node_id and serv.type='service'
) as tmp3, flow as f1, flow as f2, flow as f3, flow as f4 where tmp3.servId=f1.src_node_id and tmp3.servId=f2.src_node_id and tmp3.servId=f3.src_node_id and tmp3.servId=f4.src_node_id
and f1.source='$content://sms' and f1.sink='!INTERNET' and  f2.source='$PRODUCT' and f2.sink='!INTERNET' and  f3.source='$getSubscriberId' and f3.sink='!INTERNET' and  f4.source='$MODEL' and f4.sink='!INTERNET'


8. Pjapps.(haven't implemented dynamic receiver. lets see how many FP we get.)

 select distinct serv.id from node as recv 
 inner join edge as recv_serv on recv.id=recv_serv.src_node_id 
 inner join node as serv on recv_serv.tgt_node_id=serv.id
 inner join intentFilter as ift on ift.node_id=recv.id
 inner join flow as f1 on f1.src_node_id=serv.id
 inner join flow as f2 on f2.src_node_id=serv.id
 inner join flow as f3 on f3.src_node_id=serv.id
 inner join callerComp as cc on cc.iccg_id=66
 where recv.iccg_id=66 and recv.type='receiver'  and serv.type='service'  and (ift.name like '%SIG_STR')  and f1.source='$getDeviceId' and f1.sink='!INTERNET' and f2.source='$getSubscriberId' and f2.sink='!INTERNET' and f3.source='$getLine1Number' and f3.sink='!INTERNET' and cc.callee='<android.content.BroadcastReceiver: void abortBroadcast()>'


9 KMin. (This may generate several FP and FNs.)


/*Receiver launches service.*/
select node_id,  full_name, tgtId from ( (select node_id, e.tgt_node_id as tgtId from intentFilter ift,  edge e where ift.node_id=node_id and (ift.name like '%BOOT_COMPLETED%' ) and e.src_node_id=ift. node_id)  as tmp, 
(   /*Service leaks data*/
SELECT  distinct f1.src_node_id as serviceId  FROM flow f1, flow f2 where f1.iccg_id=64 and f2.iccg_id=64 and f1.src_node_id=f2.src_node_id and f1.source='$getDeviceId' and f1.sink='!INTERNET' and  f2.source='$getSubscriberId' and f2.sink='!INTERNET'

) as tmp2, node as nd
) where node_id=nd.id and nd.type='receiver' and serviceId=tgtId




