<!DOCTYPE html>
<html lang="en" class="fuelux">
	<head>
		<link href="/stamp/fuelux/css/fuelux.min.css" rel="stylesheet" />
		<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
		
		<style type="text/css">
		  body {
				padding-top: 60px;
				padding-bottom: 20px;
		  }

          .table tbody tr td.danger {
             background-color: #F5A9A9;
		  }

          .table tbody tr td.warning {
             background-color: #F5DA81;
		  }

          .table tbody tr td.success {
             background-color: #BCF5A9;
		  }

		  .table tbody tr.header {
             background-color: #F2F2F2;
		  }
  		</style>
  		
		<link href="/stamp/fuelux/css/fuelux-responsive.min.css" rel="stylesheet" />
	</head>

	<body>
	  <div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
		  <div class="container">
			<ul class="nav pull-left">
			  <li><a class="brand" href="#">STAMP&alpha;</a></li>
			</ul>
		  </div>
		</div>
	  </div>
	  <div class="container-fluid">
		<div class="row-fluid">
		  <div class="span2">
		  </div>
 		  <div class="span8" id="summarytable">
			<table id="appsdata" class="table table-bordered" align="center">
			  <tbody>
			  </tbody>
			</table>
		  </div>
		  <div class="span2">
		  </div>
		</div>
	  </div>
	  
	  <script src="/stamp/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
	  <script src="/stamp/fuelux/loader.js" type="text/javascript"></script>

	  <script>
		var iconmap = { "HTTP" : "glyphicon-cloud-upload",
		                "Internet" : "glyphicon-cloud-upload",
                        "SMS" : "glyphicon-envelope",
                        "File" : "glyphicon-floppy-save" }; 

		function getParameterByName(name) {
          var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
          return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
	    }
		
        $(function() {
		
          'use strict';
		
          $.ajax({
            type: "GET",
            url: "../dbreader",
            data: {dbpath: getParameterByName("dbpath"), formatfilepath: getParameterByName("format")},
            dataType: "json",
            success: function(rows) {
              var header = '<tr class="header"><th>SHA256</th><th>APK Name</th>';
		      var datatypes = rows[0];
		      for (var j in datatypes) { 
                  header += '<th>'+ datatypes[j] + '</th>';
              }
              header += '<th>Privacy Violation Index (PVI)</th>'
		      header += '</tr>';
		      $(header).appendTo('#appsdata > tbody:last');

		      var numrows = rows.length;
              for (var i = 1; i < numrows; i++) {
                var row = rows[i];

                var sha = row.sha;
		        var shortsha = sha.substring(0,4);
		        shortsha += '...';
		        shortsha += sha.substring(sha.length-5);
				
                var app = row.app;
		        var shortapp = app.substring(0,10);
		        shortapp += '...';

		        var html =  '<tr><td><a href="#" data-toggle="tooltip" title="'+sha+'">'+ shortsha + '</a></td>';
                html += '<td><a href="#" data-toggle="tooltip" title="'+app+'">' + shortapp + '</td>';

                var flows = row.flows;
                var numredflows = 0;
                var numyellowflows = 0;
		        for (var f in flows) {
                  var flow = flows[f];
				  if(flow.length > 0) { 
                    var red = false;
                    var iconshtml = "";
		            for (var sink in flow) {
                      var sinkDesc = flow[sink][0];
                      var icon = iconmap[sinkDesc];
                      var sinkClass = flow[sink][1];
		              if(sinkClass == 'OffDevice') {
                        iconshtml += '<div style="text-align: center;" class="glyphicon '+icon+'"></div>&nbsp;';  
                        red = true;
                      }
                      else if(sinkClass == 'OnDevice') {
                        iconshtml += '<div style="text-align: center;" class="glyphicon '+icon+'"></div>&nbsp;';
                      }
                    }
                    if(red == true) {
                       numredflows++;
                       html += '<td class="danger">'+iconshtml+'</td>';
                    } else {
                       numyellowflows++;
                       html += '<td class="warning">'+iconshtml+'</td>';
		            }
                  } else 
                     html += '<td class="success"></td>';
		        }
                var yellowweight = 0.5;
                var numflows = yellowweight * numyellowflows + numredflows;
                var pvi = Math.round((numflows/flows.length)*10);
                html += '<td><span class="badge badge-important">'+pvi+'</span></td>';
                html += '</tr>';
		        $(html).appendTo('#appsdata > tbody:last');
                console.log(row.app);
              }
            }
          });

        });
      </script>
	</body>
</html>
